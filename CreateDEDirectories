Sub CreateDEDirectories()
    Dim baseFolderPath As String
    Dim refFolderPath As String
    Dim cell As Range
    Dim directoryName As String
    Dim fs As Object
    Dim selectedPath As FileDialog
    Dim refPathDialog As FileDialog
    Dim useTemplate As VbMsgBoxResult
    Dim overwriteFolders As VbMsgBoxResult
    Dim file As Object, subfolder As Object
    Dim sourceFolder As Object, targetFolderPath As String

    ' Prompt user to select base folder
    Set selectedPath = Application.FileDialog(msoFileDialogFolderPicker)
    With selectedPath
        .Title = "Select base folder to create DEV directories"
        .AllowMultiSelect = False
        If .Show <> -1 Then
            MsgBox "Operation cancelled.", vbInformation
            Exit Sub
        End If
        baseFolderPath = .SelectedItems(1)
    End With
    If Right(baseFolderPath, 1) <> "\" Then baseFolderPath = baseFolderPath & "\"

    ' Ask if reference folder will be used
    useTemplate = MsgBox("Would you like to use a reference directory to copy into each new folder?", vbYesNo + vbQuestion, "Use Template")

    If useTemplate = vbYes Then
        Set refPathDialog = Application.FileDialog(msoFileDialogFolderPicker)
        With refPathDialog
            .Title = "Select reference folder to copy contents from"
            .AllowMultiSelect = False
            If .Show <> -1 Then
                MsgBox "Operation cancelled.", vbInformation
                Exit Sub
            End If
            refFolderPath = .SelectedItems(1)
        End With
        If Right(refFolderPath, 1) <> "\" Then refFolderPath = refFolderPath & "\"
    Else
        refFolderPath = ""
    End If

    ' Ask once if folders should be overwritten
    overwriteFolders = MsgBox("Some folders may already exist." & vbCrLf & _
                              "Would you like to overwrite them?", _
                              vbYesNoCancel + vbQuestion, "Overwrite Existing Folders?")
    If overwriteFolders = vbCancel Then
        MsgBox "Operation cancelled by user.", vbInformation
        Exit Sub
    End If

    Set fs = CreateObject("Scripting.FileSystemObject")

    ' Loop through selection
    For Each cell In Selection
        If Not IsEmpty(cell.Value) And Trim(cell.Value) <> "" Then
            directoryName = baseFolderPath & "DE" & Trim(cell.Value)

            If fs.FolderExists(directoryName) Then
                If overwriteFolders = vbYes Then
                    On Error Resume Next
                    fs.DeleteFolder directoryName, True
                    On Error GoTo 0
                    fs.CreateFolder directoryName
                Else
                    Debug.Print "Skipped existing folder: " & directoryName
                    GoTo NextCell
                End If
            Else
                fs.CreateFolder directoryName
            End If

            ' Copy reference contents if selected
            If refFolderPath <> "" Then
                Set sourceFolder = fs.GetFolder(refFolderPath)
                targetFolderPath = directoryName

                ' Copy files
                For Each file In sourceFolder.Files
                    fs.CopyFile file.Path, targetFolderPath & "\" & file.Name, True
                Next file

                ' Copy subfolders recursively
                For Each subfolder In sourceFolder.SubFolders
                    fs.CopyFolder subfolder.Path, targetFolderPath & "\" & subfolder.Name, True
                Next subfolder
            End If
        End If
NextCell:
    Next cell

    MsgBox "Folder creation complete.", vbInformation
End Sub

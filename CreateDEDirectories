Sub CreateDEDirectories()
    Dim baseFolderPath As String
    Dim refFolderPath As String
    Dim cell As Range
    Dim directoryName As String
    Dim fs As Object
    Dim selectedPath As FileDialog
    Dim refPathDialog As FileDialog
    Dim useTemplate As VbMsgBoxResult

    ' Prompt user to select the base folder
    Set selectedPath = Application.FileDialog(msoFileDialogFolderPicker)
    With selectedPath
        .Title = "Select base folder to create DEV directories"
        .AllowMultiSelect = False
        If .Show <> -1 Then
            MsgBox "Operation cancelled.", vbInformation
            Exit Sub
        End If
        baseFolderPath = .SelectedItems(1)
    End With

    ' Ensure base folder path ends with backslash
    If Right(baseFolderPath, 1) <> "\" Then
        baseFolderPath = baseFolderPath & "\"
    End If

    ' Ask user if they want to use a reference directory
    useTemplate = MsgBox("Would you like to use a reference directory to copy into each new folder?", vbYesNo + vbQuestion, "Use Template")

    If useTemplate = vbYes Then
        Set refPathDialog = Application.FileDialog(msoFileDialogFolderPicker)
        With refPathDialog
            .Title = "Select reference folder to copy contents from"
            .AllowMultiSelect = False
            If .Show <> -1 Then
                MsgBox "Operation cancelled.", vbInformation
                Exit Sub
            End If
            refFolderPath = .SelectedItems(1)
        End With

        ' Ensure reference path ends with backslash
        If Right(refFolderPath, 1) <> "\" Then
            refFolderPath = refFolderPath & "\"
        End If
    Else
        refFolderPath = ""
    End If

    ' Set file system object
    Set fs = CreateObject("Scripting.FileSystemObject")

    ' Loop through each selected cell
    For Each cell In Selection
        If Not IsEmpty(cell.Value) And Trim(cell.Value) <> "" Then
            directoryName = baseFolderPath & "DE" & Trim(cell.Value)
            
            ' Skip if folder already exists
            If fs.FolderExists(directoryName) Then
                Debug.Print "Skipped existing folder: " & directoryName
                GoTo NextCell
            End If

            ' Create new folder
            fs.CreateFolder directoryName
            
            ' If reference folder is selected, copy its contents
            If refFolderPath <> "" Then
                CopyFolderContents refFolderPath, directoryName
            End If
        End If
NextCell:
    Next cell

    MsgBox "Folders created successfully (existing ones were skipped).", vbInformation
End Sub

Sub CopyFolderContents(sourcePath As String, targetPath As String)
    Dim fso As Object
    Dim folder As Object
    Dim subfolder As Object
    Dim file As Object

    Set fso = CreateObject("Scripting.FileSystemObject")

    ' Copy files
    For Each file In fso.GetFolder(sourcePath).Files
        fso.CopyFile file.Path, targetPath & "\" & file.Name, False ' FALSE = do not overwrite
    Next file

    ' Copy subfolders recursively
    For Each subfolder In fso.GetFolder(sourcePath).SubFolders
        If Not fso.FolderExists(targetPath & "\" & subfolder.Name) Then
            fso.CopyFolder subfolder.Path, targetPath & "\" & subfolder.Name, False ' FALSE = do not overwrite
        End If
    Next subfolder
End Sub

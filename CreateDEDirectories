Sub CreateDEDirectories()
    Dim baseFolderPath As String
    Dim refFolderPath As String
    Dim cell As Range
    Dim directoryName As String
    Dim fs As Object
    Dim selectedPath As FileDialog
    Dim refPathDialog As FileDialog
    Dim useTemplate As VbMsgBoxResult

    ' Prompt user to select the base folder
    Set selectedPath = Application.FileDialog(msoFileDialogFolderPicker)
    With selectedPath
        .Title = "Select base folder to create DEV directories"
        .AllowMultiSelect = False
        If .Show <> -1 Then
            MsgBox "Operation cancelled.", vbInformation
            Exit Sub
        End If
        baseFolderPath = .SelectedItems(1)
    End With

    ' Ensure base folder path ends with backslash
    If Right(baseFolderPath, 1) <> "\" Then
        baseFolderPath = baseFolderPath & "\"
    End If

    ' Ask user if they want to use a reference directory
    useTemplate = MsgBox("Would you like to use a reference directory to copy into each new folder?", vbYesNo + vbQuestion, "Use Template")

    If useTemplate = vbYes Then
        Set refPathDialog = Application.FileDialog(msoFileDialogFolderPicker)
        With refPathDialog
            .Title = "Select reference folder to copy contents from"
            .AllowMultiSelect = False
            If .Show <> -1 Then
                MsgBox "Operation cancelled.", vbInformation
                Exit Sub
            End If
            refFolderPath = .SelectedItems(1)
        End With

        ' Ensure reference path ends with backslash
        If Right(refFolderPath, 1) <> "\" Then
            refFolderPath = refFolderPath & "\"
        End If
    Else
        refFolderPath = ""
    End If

    ' Set file system object
    Set fs = CreateObject("Scripting.FileSystemObject")

    ' Loop through each used cell in Column A
    For Each cell In ActiveSheet.Range("A1:A" & ActiveSheet.Cells(Rows.Count, "A").End(xlUp).Row)
        If Trim(cell.Value) <> "" Then
            directoryName = baseFolderPath & "DE" & Trim(cell.Value)
            If Not fs.FolderExists(directoryName) Then
                fs.CreateFolder directoryName
            End If
            
            ' If reference folder is selected, copy its contents
            If refFolderPath <> "" Then
                CopyFolderContents refFolderPath, directoryName
            End If
        End If
    Next cell

    MsgBox "Folders created successfully!", vbInformation
End Sub

Sub CopyFolderContents(sourcePath As String, targetPath As String)
    Dim fso As Object
    Dim folder As Object
    Dim subfolder As Object
    Dim file As Object

    Set fso = CreateObject("Scripting.FileSystemObject")

    ' Copy files
    For Each file In fso.GetFolder(sourcePath).Files
        fso.CopyFile file.Path, targetPath & "\" & file.Name, True
    Next file

    ' Copy subfolders recursively
    For Each subfolder In fso.GetFolder(sourcePath).SubFolders
        fso.CopyFolder subfolder.Path, targetPath & "\" & subfolder.Name, True
    Next subfolder
End Sub
